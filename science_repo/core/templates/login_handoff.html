<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Signing you inâ€¦</title>
  <style>html,body{background:#fff;color:#111;margin:0;padding:0}</style>
</head>
<body>
<script>
(function(){
  try {
    var access = "{{ access_token|default:''|escapejs }}";
    var refresh = "{{ refresh_token|default:''|escapejs }}";
    var userJson = "{{ user_json|default:'{}'|escapejs }}";
    var user = {};
    try { user = JSON.parse(userJson || '{}'); } catch (e) { user = {}; }

    // Persist tokens silently (helps on Safari if opener can't receive message for some reason)
    try {
      if (access && refresh) {
        localStorage.setItem('jwt_access', access);
        localStorage.setItem('jwt_refresh', refresh);
      }
    } catch (e) {}

    var base = "{{ app_base_path|default:'/'|escapejs }}";
    var origin;
    try { origin = new URL(base, window.location.href).origin; } catch (e) { origin = window.location.origin; }

    // Inform opener and close
    if (window.opener && !window.opener.closed) {
      window.opener.postMessage({
        type: 'orcid-login-success',
        access: access,
        refresh: refresh,
        user: user
      }, origin);
      setTimeout(function(){ window.close(); }, 20);
      return;
    }

    // No opener: just redirect to app base
    if (!base || base === '') base = '/';
    if (base && base.charAt(base.length-1) !== '/') base += '/';
    window.location.replace(base);
  } catch (err) {
    // Absolute minimal fallback
    try { window.close(); } catch(e) {}
  }
})();
</script>
</body>
</html>
